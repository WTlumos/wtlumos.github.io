<!DOCTYPE html>
<html lang="zh-CN,en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wtlumos.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"gitalk":{"order":-1}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="共享单车程序开发及数据采集">
<meta property="og:type" content="article">
<meta property="og:title" content="微信小程序-共享单车">
<meta property="og:url" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/index.html">
<meta property="og:site_name" content="W.T.的博客">
<meta property="og:description" content="共享单车程序开发及数据采集">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/guanwang.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/tool.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/location.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/back.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/duanxin.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/rediscuowu.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/code.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/redis-result.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/redis2.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/result.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/wallet.png">
<meta property="og:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/nearresult.png">
<meta property="article:published_time" content="2019-08-08T23:56:08.000Z">
<meta property="article:modified_time" content="2021-10-29T05:56:57.578Z">
<meta property="article:author" content="Wang Ting">
<meta property="article:tag" content="微信小程序">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/guanwang.png">

<link rel="canonical" href="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>微信小程序-共享单车 | W.T.的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">W.T.的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Every day to be a little better</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        
            
  <li class="menu-item menu-item-books">
      
    

    <a href="/books/" rel="section"><i class="fa fa-book fa-fw"></i>书单</a>

  </li>


      
        <li class="menu-item menu-item-route">
      
    

    <a href="/route/" rel="section"><i class="fas fa-route fa-fw"></i>学习路线</a>

  </li>
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-language">

    <a href="/en" rel="section"><i class="fas fa-language fa-fw"></i>English</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/WTlumos" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Wang Ting">
      <meta itemprop="description" content="技术成长笔记">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="W.T.的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          微信小程序-共享单车
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-09 07:56:08" itemprop="dateCreated datePublished" datetime="2019-08-09T07:56:08+08:00">2019-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-10-29 13:56:57" itemprop="dateModified" datetime="2021-10-29T13:56:57+08:00">2021-10-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">项目</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE/%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/" itemprop="url" rel="index"><span itemprop="name">共享单车</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>23 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote class="blockquote-center">共享单车程序开发及数据采集</blockquote>
<span id="more"></span>

<h1 id="注册微信小程序">1. 注册微信小程序</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">https://mp.weixin.qq.com/</a></p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/guanwang.png"></p>
<p>最重要的是知道AppID(小程序ID)</p>
<h1 id="开发者工具下载">2. 开发者工具下载</h1><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html">https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html</a></p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/tool.png"></p>
<h1 id="项目结构">3. 项目结构</h1><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">├── app.js             </span><br><span class="line">├── app.json       </span><br><span class="line">├── app.wxss           </span><br><span class="line">├── pages</span><br><span class="line">│   │── index</span><br><span class="line">│   │   ├── index.wxml  html</span><br><span class="line">│   │   ├── index.js    js</span><br><span class="line">│   │   ├── index.json</span><br><span class="line">│   │   └── index.wxss  css</span><br><span class="line">│   └── logs</span><br><span class="line">│       ├── logs.wxml</span><br><span class="line">│       └── logs.js</span><br><span class="line">└── utils</span><br></pre></td></tr></table></figure>

<h1 id="显示地图">4. 显示地图</h1><p><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/miniprogram/dev/component/map.html">https://developers.weixin.qq.com/miniprogram/dev/component/map.html</a></p>
<table>
<thead>
<tr>
<th>属性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>map主键标识</td>
</tr>
<tr>
<td>longitude</td>
<td>中心经度</td>
</tr>
<tr>
<td>latitude</td>
<td>中心纬度</td>
</tr>
<tr>
<td>controls</td>
<td>页面控件，扫码登录等图标位置</td>
</tr>
<tr>
<td>show-location</td>
<td>显示带有方向的当前定位点</td>
</tr>
<tr>
<td>bindcontroltap</td>
<td>点击控件时触发</td>
</tr>
<tr>
<td>scale</td>
<td>缩放级别，取值范围为3-20</td>
</tr>
<tr>
<td>markers</td>
<td>标记点，显示附近车辆</td>
</tr>
<tr>
<td>bindregionchange</td>
<td>视野发生变化时触发</td>
</tr>
<tr>
<td>style</td>
<td>整个map大小</td>
</tr>
</tbody></table>
<h1 id="生命周期">5. 生命周期</h1><p>onload 监听页面加载</p>
<p>onReady 监听页面初次渲染完成</p>
<h1 id="获取设备定位">6. 获取设备定位</h1><p>允许设备取值</p>
<p>在app.json</p>
<p>“page”下 添加</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"> <span class="punctuation">]</span><span class="punctuation">,</span> </span><br><span class="line"><span class="attr">&quot;permission&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;scope.userLocation&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;您的位置将用于车辆查询&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>index.wxml</p>
<p>longitude，longitude的值从js内获取</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span> </span></span><br><span class="line"><span class="tag"><span class="attr">id</span>=<span class="string">&quot;mymap&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">longitude</span>=<span class="string">&#x27;&#123;&#123;longitude&#125;&#125;&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="attr">latitude</span>=<span class="string">&#x27;&#123;&#123;longitude&#125;&#125;&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="attr">show-location</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">scale</span>=<span class="string">&quot;17&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">style</span>=<span class="string">&#x27;width:100%;height:100%&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>index.js</p>
<p>获取当前设备信息</p>
<p>wx.getLocation()</p>
<p>获取成功后调用，res中存储了定位信息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>将值设置为页面全局变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">that.<span class="title function_">setData</span>(&#123;</span><br><span class="line">     <span class="attr">longitude</span>:long,</span><br><span class="line">     <span class="attr">latitude</span>:lat</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<p>整合代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Page</span>(&#123;</span><br><span class="line">   <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">longitude</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">latitude</span>: <span class="number">0</span>,</span><br><span class="line"> 	&#125;,</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听页面函数 -- 监听页面加载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="attr">onLoad</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"> 	<span class="comment">//存储当前页面</span></span><br><span class="line"> 	 <span class="keyword">var</span> that =<span class="variable language_">this</span>;    </span><br><span class="line">  	<span class="comment">//模拟器位置</span></span><br><span class="line">  	 wx.<span class="title function_">getLocation</span>(&#123;</span><br><span class="line">    	 <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">     	  <span class="comment">//console.log(res);</span></span><br><span class="line">     	  <span class="keyword">var</span> long=res.<span class="property">longitude</span>;</span><br><span class="line">       	<span class="keyword">var</span> lat = res.<span class="property">latitude</span>;</span><br><span class="line">      		that.<span class="title function_">setData</span>(&#123;</span><br><span class="line">        	 <span class="attr">longitude</span>:long,</span><br><span class="line">          <span class="attr">latitude</span>:lat</span><br><span class="line">      	 &#125;)</span><br><span class="line">     	&#125;,</span><br><span class="line">   	&#125;)</span><br><span class="line"> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>模拟器无法定位，模拟定位</p>
<p>在线查找经纬度 <a target="_blank" rel="noopener" href="http://www.gpsspg.com/maps.htm">http://www.gpsspg.com/maps.htm</a></p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/location.png"></p>
<h1 id="添加事件">7. 添加事件</h1><h2 id="添加图片">7.1. 添加图片</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span> <span class="attr">controls</span>=<span class="string">&#x27;&#123;&#123;controls&#125;&#125;&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>wx.getSystemInfo 获取设备信息，成功返回res数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">getSystemInfo</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>通过屏幕宽和高相对摆放组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">that.<span class="title function_">setData</span>(&#123;</span><br><span class="line">   <span class="attr">controls</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//扫码开锁</span></span><br><span class="line">        <span class="comment">//组件标识</span></span><br><span class="line">        <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="comment">//图片路径</span></span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;/images/lock.png&#x27;</span>,</span><br><span class="line">        <span class="comment">//图片位置</span></span><br><span class="line">        <span class="attr">position</span>: &#123;</span><br><span class="line">           <span class="attr">width</span>: <span class="number">100</span>,</span><br><span class="line">           <span class="attr">height</span>: <span class="number">50</span>,</span><br><span class="line">           <span class="attr">left</span>: width/<span class="number">2</span>-<span class="number">50</span>,</span><br><span class="line">           <span class="attr">top</span>: height-<span class="number">60</span></span><br><span class="line">         &#125;,</span><br><span class="line">        <span class="comment">//可点击</span></span><br><span class="line">         <span class="attr">clickable</span>:<span class="literal">true</span>      </span><br><span class="line">      &#125;,</span><br><span class="line">     	&#123;</span><br><span class="line">        <span class="comment">//钱包</span></span><br><span class="line">       	<span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;/images/pay.png&#x27;</span>,</span><br><span class="line">        <span class="attr">position</span>: &#123;</span><br><span class="line">          <span class="attr">width</span>: <span class="number">35</span>,</span><br><span class="line">          <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">          <span class="attr">left</span>: width - <span class="number">40</span>,</span><br><span class="line">          <span class="attr">top</span>: height - <span class="number">100</span></span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">clickable</span>: <span class="literal">true</span></span><br><span class="line">     	&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>整合代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Page</span>(&#123;</span><br><span class="line">  <span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">longitude</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">latitude</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">controls</span>:[],</span><br><span class="line">  &#125;,</span><br><span class="line">	<span class="comment">//设备信息</span></span><br><span class="line">	<span class="attr">onLoad</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//存储当前页面</span></span><br><span class="line">  	 <span class="keyword">var</span> that =<span class="variable language_">this</span>;    </span><br><span class="line">   	<span class="comment">//模拟器位置</span></span><br><span class="line">   	 wx.<span class="title function_">getLocation</span>(&#123;</span><br><span class="line">     	 <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">      	  <span class="comment">//console.log(res);</span></span><br><span class="line">      	  <span class="keyword">var</span> long=res.<span class="property">longitude</span>;</span><br><span class="line">        	<span class="keyword">var</span> lat = res.<span class="property">latitude</span>;</span><br><span class="line">       		that.<span class="title function_">setData</span>(&#123;</span><br><span class="line">         	 <span class="attr">longitude</span>:long,</span><br><span class="line">           <span class="attr">latitude</span>:lat</span><br><span class="line">       	 &#125;)</span><br><span class="line">      	&#125;,</span><br><span class="line">    	&#125;)</span><br><span class="line">    wx.<span class="title function_">getSystemInfo</span>(&#123;</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">res</span>) &#123;</span><br><span class="line">        <span class="comment">//屏幕宽</span></span><br><span class="line">        <span class="keyword">var</span> width=res.<span class="property">windowWidth</span>;</span><br><span class="line">        <span class="comment">//屏幕高</span></span><br><span class="line">        <span class="keyword">var</span> height=res.<span class="property">windowHeight</span>;</span><br><span class="line">        that.<span class="title function_">setData</span>(&#123;</span><br><span class="line">          <span class="attr">controls</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">//扫码开锁</span></span><br><span class="line">              <span class="attr">id</span>: <span class="number">1</span>,</span><br><span class="line">              <span class="attr">iconPath</span>: <span class="string">&#x27;/images/lock.png&#x27;</span>,</span><br><span class="line">              <span class="attr">position</span>: &#123;</span><br><span class="line">                <span class="attr">width</span>: <span class="number">100</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">50</span>,</span><br><span class="line">                <span class="attr">left</span>: width/<span class="number">2</span>-<span class="number">50</span>,</span><br><span class="line">                <span class="attr">top</span>: height-<span class="number">60</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">clickable</span>:<span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">//钱包</span></span><br><span class="line">              <span class="attr">id</span>: <span class="number">2</span>,</span><br><span class="line">              <span class="attr">iconPath</span>: <span class="string">&#x27;/images/pay.png&#x27;</span>,</span><br><span class="line">              <span class="attr">position</span>: &#123;</span><br><span class="line">                <span class="attr">width</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">left</span>: width - <span class="number">40</span>,</span><br><span class="line">                <span class="attr">top</span>: height - <span class="number">100</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">clickable</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">//报警</span></span><br><span class="line">              <span class="attr">id</span>: <span class="number">3</span>,</span><br><span class="line">              <span class="attr">iconPath</span>: <span class="string">&#x27;/images/warn.png&#x27;</span>,</span><br><span class="line">              <span class="attr">position</span>: &#123;</span><br><span class="line">                <span class="attr">width</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">left</span>: width - <span class="number">40</span>,</span><br><span class="line">                <span class="attr">top</span>: height - <span class="number">60</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">clickable</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">//定位点</span></span><br><span class="line">              <span class="attr">id</span>: <span class="number">4</span>,</span><br><span class="line">              <span class="attr">iconPath</span>: <span class="string">&#x27;/images/locate.png&#x27;</span>,</span><br><span class="line">              <span class="attr">position</span>: &#123;</span><br><span class="line">                <span class="attr">width</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">left</span>: width/<span class="number">30</span>,</span><br><span class="line">                <span class="attr">top</span>: height - <span class="number">60</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">clickable</span>: <span class="literal">true</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">//图标中心点</span></span><br><span class="line">              <span class="attr">id</span>: <span class="number">5</span>,</span><br><span class="line">              <span class="attr">iconPath</span>: <span class="string">&#x27;/images/cur.png&#x27;</span>,</span><br><span class="line">              <span class="attr">position</span>: &#123;</span><br><span class="line">                <span class="attr">width</span>: <span class="number">23</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">40</span>,</span><br><span class="line">                <span class="attr">left</span>: width / <span class="number">2</span> -<span class="number">12</span>,</span><br><span class="line">                <span class="attr">top</span>: height /<span class="number">2</span> - <span class="number">40</span></span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">//添加车辆</span></span><br><span class="line">              <span class="attr">id</span>: <span class="number">6</span>,</span><br><span class="line">              <span class="attr">iconPath</span>: <span class="string">&#x27;/images/add.png&#x27;</span>,</span><br><span class="line">              <span class="attr">position</span>: &#123;</span><br><span class="line">                <span class="attr">width</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">                <span class="attr">left</span>: width / <span class="number">30</span>,</span><br><span class="line">                <span class="attr">top</span>: height / <span class="number">30</span></span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="attr">clickable</span>: <span class="literal">true</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>整体显示</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/back.png"></p>
<h2 id="绑定事件">7.2. 绑定事件</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span> <span class="attr">bindcontroltap</span>=<span class="string">&quot;controltap&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>controltap定义为一个函数</p>
<p>e 返回点击事件数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">page</span>(&#123;</span><br><span class="line">  <span class="attr">onload</span>:<span class="title function_">funtion</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//创建一个map上下文，用于调用地图相关方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">mapCtx</span>=wx.<span class="title function_">createMapContext</span>(<span class="string">&quot;mymap&quot;</span>);</span><br><span class="line">	&#125;,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 控件点击事件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">controltap</span>: <span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="comment">//console.log(e);</span></span><br><span class="line">    <span class="comment">//包装page页面</span></span><br><span class="line">    <span class="keyword">var</span> that = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">var</span> id = e.<span class="property">controlId</span>;</span><br><span class="line">    <span class="keyword">switch</span>(id)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:&#123;</span><br><span class="line">        <span class="comment">//扫码开锁</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:&#123;</span><br><span class="line">        <span class="comment">//返回到定位点</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mapCtx</span>.<span class="title function_">moveToLocation</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">//添加车辆</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="点击事件实现">7.3. 点击事件实现</h2><p>wx.navigateTo({  })</p>
<p>当点击扫码开锁时扫码</p>
<p>在线制作二维码<a target="_blank" rel="noopener" href="https://www.liantu.com/">https://www.liantu.com/</a></p>
<p>事件 wx.scanCode({})</p>
<p>成功时返回二维码内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">result</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">controltap</span>: <span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="comment">//console.log(e);</span></span><br><span class="line">    <span class="keyword">var</span> that = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">var</span> id = e.<span class="property">controlId</span>;</span><br><span class="line">    <span class="keyword">switch</span>(id)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:&#123;</span><br><span class="line">        <span class="comment">//扫码开锁按钮</span></span><br><span class="line">        wx.<span class="title function_">scanCode</span>(&#123;</span><br><span class="line">          <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">result</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:&#123;</span><br><span class="line">        <span class="comment">//locate定位</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mapCtx</span>.<span class="title function_">moveToLocation</span>()</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="SpringBoot">8. SpringBoot</h1><p><a target="_blank" rel="noopener" href="https://start.spring.io/">https://start.spring.io/</a></p>
<h1 id="设置全局数值">9. 设置全局数值</h1><p>app.js中的方法，值是所有页面共享的</p>
<p>设置status，用于定位用户状态</p>
<p>status：0-未注册，1-未支付，2-未实名 ，3-开始用车</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">App</span>(&#123;</span><br><span class="line">  <span class="attr">onLaunch</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">//页面共享数据</span></span><br><span class="line">  <span class="attr">globalData</span>: &#123;</span><br><span class="line">    <span class="attr">userInfo</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">status</span>:<span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>页面获取全局数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status=<span class="variable language_">this</span>.<span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">status</span>;</span><br></pre></td></tr></table></figure>

<h1 id="注册页面">10. 注册页面</h1><h2 id="添加注册页面">10.1. 添加注册页面</h2><p>不需要手动添加</p>
<p>app.json中添加register页面，保存，自动生成</p>
<p>这里的顺序即为页面调用顺序</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;pages/index/index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;pages/register/register&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;pages/logs/logs&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>当status&#x3D;0跳转到注册页面</p>
<p>wx.navigateTo()</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(status==<span class="number">0</span>)&#123;</span><br><span class="line">    wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">       <span class="attr">url</span>: <span class="string">&#x27;../register/register&#x27;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现手机绑定">10.2. 实现手机绑定</h2><p>手机国际区号选择</p>
<p> picker</p>
<p>bindchange&#x3D;”bindCountryCodeChange” </p>
<p>value&#x3D;”“ </p>
<p>range&#x3D;”</p>
<p>显示</p>


<p>后台数据</p>
<p>data: {</p>
<p>​    countryCodes: [“86”, “80”, “84”, “87”],</p>
<p>​    countryCodeIndex: 0，</p>
<p>  },</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">picker</span> <span class="attr">bindchange</span>=<span class="string">&quot;bindCountryCodeChange&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;countryCodeIndex&#125;&#125;&quot;</span> <span class="attr">range</span>=<span class="string">&quot;&#123;&#123;countryCodes&#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;weui-select&quot;</span>&gt;</span>&#123;&#123;countryCodes[countryCodeIndex]&#125;&#125;	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">picker</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点击事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bindCountryCodeChange</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(&#x27;picker country code 发生选择改变，携带值为&#x27;, e.detail.value);</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">      <span class="attr">countryCodeIndex</span>: e.<span class="property">detail</span>.<span class="property">value</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>填写手机号</p>
<p>绑定输入事件，获取输入内容</p>
<p>bindinput</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;weui-input&quot;</span> <span class="attr">name</span>=<span class="string">&quot;phoneNum&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">bindinput</span>=<span class="string">&quot;inputPhoneNum&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>获取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data</span>: &#123;</span><br><span class="line">    <span class="attr">phoneNum</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line"><span class="attr">inputPhoneNum</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="comment">//console.log(e)</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setData</span>(&#123;</span><br><span class="line">      <span class="attr">phoneNum</span>: e.<span class="property">detail</span>.<span class="property">value</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>获取验证码点击事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;weui-vcode-btn&quot;</span> <span class="attr">bindtap</span>=<span class="string">&quot;genVerifyCode&quot;</span>&gt;</span>获取验证码<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="连接服务器">10.2.1. 连接服务器</h3><p>wx.request({})</p>
<p>url  请求地址</p>
<p>data 请求参数</p>
<p>method 请求方式</p>
<p>sunccess 响应数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">genVerifyCode</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">countryCodeIndex</span>;</span><br><span class="line">    <span class="keyword">var</span> countryCode = <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">countryCodes</span>[index];</span><br><span class="line">    <span class="keyword">var</span> phoneNum = <span class="variable language_">this</span>.<span class="property">data</span>.<span class="property">phoneNum</span>;</span><br><span class="line">    <span class="comment">// console.log(countryCode,phoneNum)</span></span><br><span class="line">    wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">      <span class="comment">//小程序访问的网络请求协议必须是https，url里面不能有端口号</span></span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;http://localhost:8080/user/genCode&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">countryCode</span>: countryCode,</span><br><span class="line">        <span class="attr">phoneNum</span>: phoneNum</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">      <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">        wx.<span class="title function_">showToast</span>(&#123;</span><br><span class="line">          <span class="attr">title</span>: <span class="string">&#x27;已发送，请查收!&#x27;</span>,</span><br><span class="line">          <span class="attr">duration</span>: <span class="number">2000</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//console.log(res)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>点击获取验证码，</p>
<p>查看Console 虽然错误但得到一个请求URL<a target="_blank" rel="noopener" href="http://localhost:8080/user/genCode?countryCode=86&phoneNum=123">http://localhost:8080/user/genCode?countryCode=86&amp;phoneNum=123</a></p>
<h3 id="SpringBoot–redis">10.2.2. SpringBoot–redis</h3><p>采用redis存储数据，实现只存在3分钟</p>
<p>创建UserController.java 接收区号和手机号，使其返回json类型的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.runaccpeted.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	UserService service;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@RequestMapping(&quot;/genCode&quot;)</span></span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">genCode</span><span class="params">(String countryCode,String phoneNum)</span>&#123;</span><br><span class="line">		String code=service.register(countryCode,phoneNum);	</span><br><span class="line">		<span class="comment">//System.out.println(code);</span></span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应创建UserService接口 进行操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	String <span class="title function_">register</span><span class="params">(String countryCode, String phoneNum)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建具体实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.runaccpeted.dao.UserDao;</span><br><span class="line"><span class="keyword">import</span> com.runaccpeted.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Resource</span></span><br><span class="line">	UserDao dao;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(String countryCode, String phoneNum)</span> &#123;	</span><br><span class="line">		<span class="keyword">return</span> dao.register(countryCode,phoneNum);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应数据库dao层，对接数据库</p>
<p>需要添加redis依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置redis</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置redis</span></span><br><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">192.168.0.101 #本地IP</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.redis.pool.max-active</span>=<span class="string">20</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring-redis.pool.max-idle</span>=<span class="string">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring-redis.pool.min-idle</span>=<span class="string">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring-redis.pool.max-wait</span>=<span class="string">-1</span></span><br></pre></td></tr></table></figure>

<h3 id="腾讯云短信服务">10.2.3. 腾讯云短信服务</h3><p><a target="_blank" rel="noopener" href="https://console.cloud.tencent.com/smsv2">https://console.cloud.tencent.com/smsv2</a></p>
<p>需要实名认证！ 没上线怎么认证，又不是企业</p>
<p>记录SpringBoot操作流程</p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/document/product/382/13613">https://cloud.tencent.com/document/product/382/13613</a></p>
<p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-- 短信云服务 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.qcloudsms<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>qcloudsms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用</p>
<p>将appid，appkey永久存入redis中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.dao;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.qcloudsms.SmsSingleSender;</span><br><span class="line"><span class="keyword">import</span> com.github.qcloudsms.SmsSingleSenderResult;</span><br><span class="line"><span class="keyword">import</span> com.github.qcloudsms.httpclient.HTTPException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">register</span><span class="params">(String countryCode, String phoneNum)</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">int</span> <span class="variable">appid</span> <span class="operator">=</span> Integer.parseInt(redisTemplate.opsForValue().get(<span class="string">&quot;appid&quot;</span>)); </span><br><span class="line">		<span class="type">String</span> <span class="variable">appkey</span> <span class="operator">=</span> redisTemplate.opsForValue().get(<span class="string">&quot;appkey&quot;</span>);			</span><br><span class="line">		<span class="type">boolean</span> flag=<span class="literal">true</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//生成4位验证码</span></span><br><span class="line">		String code=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">			code+=(<span class="type">int</span>)(Math.random()*<span class="number">10</span>)+<span class="string">&quot;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//手机号，验证码保存到redis中 300s</span></span><br><span class="line">		redisTemplate.opsForValue().set(phoneNum, code, <span class="number">300</span>,TimeUnit.SECONDS);	</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//腾讯云短信业务</span></span><br><span class="line">		<span class="type">SmsSingleSender</span> <span class="variable">ssender</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SmsSingleSender</span>(appid, appkey);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//send(单发, 国际区号, 手机号, 短信模板, &quot;&quot;, &quot;&quot;);  </span></span><br><span class="line">      <span class="comment">//短信模板与配置中一致</span></span><br><span class="line">			<span class="type">SmsSingleSenderResult</span> <span class="variable">result</span> <span class="operator">=</span> ssender.send(<span class="number">0</span>, countryCode, phoneNum, <span class="string">&quot;您的登陆验证码为&quot;</span>+code, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">		</span><br><span class="line">			<span class="comment">//手机号，验证码保存到redis中 300s</span></span><br><span class="line">			redisTemplate.opsForValue().set(phoneNum, code, <span class="number">300</span>,TimeUnit.SECONDS);	</span><br><span class="line">		&#125; <span class="keyword">catch</span> (HTTPException | JSONException | IOException e) &#123;</span><br><span class="line">			flag=<span class="literal">false</span>;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> flag;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>。。。没认证手机是收不到的。。。</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/duanxin.png"></p>
<h3 id="不调用腾讯云短信服务">10.2.4. 不调用腾讯云短信服务</h3><p>随机生成四位数字，充当验证码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.json.JSONException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.qcloudsms.SmsSingleSender;</span><br><span class="line"><span class="keyword">import</span> com.github.qcloudsms.SmsSingleSenderResult;</span><br><span class="line"><span class="keyword">import</span> com.github.qcloudsms.httpclient.HTTPException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(String countryCode, String phoneNum)</span> &#123;</span><br><span class="line">   <span class="comment">//生成4位验证码</span></span><br><span class="line">		String code=<span class="string">&quot;&quot;</span>;</span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">			code+=(<span class="type">int</span>)(Math.random()*<span class="number">10</span>)+<span class="string">&quot;&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//手机号，验证码保存到redis中 300s</span></span><br><span class="line">		redisTemplate.opsForValue().set(phoneNum, code, <span class="number">300</span>,TimeUnit.SECONDS);	</span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>微信直接接收验证码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wx.showModal(&#123;</span><br><span class="line">   content:<span class="string">&#x27;您的注册验证码为&#x27;</span>+res.data</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>❌</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/rediscuowu.png"></p>
<p>需要修改redis保护模式</p>
<p>vi &#x2F;usr&#x2F;local&#x2F;Cellar&#x2F;redis&#x2F;5.0.5&#x2F;bin&#x2F;redis.conf</p>
<p>protected-mode no</p>
<p>重启 redis-server</p>
<p>微信小程序点击获取验证码</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/code.png"></p>
<p>redis</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/redis-result.png"></p>
<p>5分钟后</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/redis2.png"></p>
<h3 id="验证用户输入">10.2.5. 验证用户输入</h3><p>取用户输入的手机号和验证码与redis中进行匹配</p>
<p>整个注册页面的两个input框包在form中</p>
<p>bindsubmit  绑定提交事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">bindsubmit</span>=<span class="string">&quot;formSubmit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;weui-input&quot;</span> <span class="attr">name</span>=<span class="string">&quot;phoneNum&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入手机号码&quot;</span> <span class="attr">bindinput</span>=<span class="string">&quot;inputPhoneNum&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;weui-input&quot;</span> <span class="attr">name</span>=<span class="string">&quot;verifyCode&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入验证码&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;weui-btn&quot;</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span> <span class="attr">formType</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>确定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>提交事件 返回true&#x2F;false</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">formSubmit</span>: <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">   <span class="keyword">var</span> phoneNum = e.<span class="property">detail</span>.<span class="property">value</span>.<span class="property">phoneNum</span>;</span><br><span class="line">   <span class="keyword">var</span> verifyCode = e.<span class="property">detail</span>.<span class="property">value</span>.<span class="property">verifyCode</span>;</span><br><span class="line">   wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/user/verify&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>:&#123;</span><br><span class="line">      <span class="string">&#x27;content-type&#x27;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">data</span>:&#123;</span><br><span class="line">     <span class="attr">phoneNum</span>:phoneNum,</span><br><span class="line">     <span class="attr">verifyCode</span>:verifyCode</span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>取redis中的手机号对应验证码</p>
<p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/verify&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String phoneNum,String verifyCode, HttpServletRequest request)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> service.verify(phoneNum,verifyCode);		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String phoneNum, String verifyCode)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> dao.verify(phoneNum,verifyCode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserDao.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verify</span><span class="params">(String phoneNum, String verifyCode)</span> &#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> redisTemplate.opsForValue().get(phoneNum);</span><br><span class="line">	<span class="comment">//System.out.println(&quot;redis &quot;+code);</span></span><br><span class="line">	<span class="keyword">if</span>(verifyCode.equals(code))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注册用户到MongoDB">11. 注册用户到MongoDB</h1><p>当&#x2F;user&#x2F;verify 返回true时，应该传入手机号和注册时间，注册到mongodb中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">      <span class="keyword">if</span>(res.<span class="property">data</span>)&#123;</span><br><span class="line">          wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/user/register&#x27;</span>,</span><br><span class="line">            <span class="attr">method</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            <span class="comment">//保存到mongodb中</span></span><br><span class="line">            <span class="attr">data</span>:&#123;</span><br><span class="line">              <span class="attr">phoneNum</span>:phoneNum,</span><br><span class="line">              <span class="attr">regDate</span>:<span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125;           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将整个json数据映射到一个User类</p>
<p>@Document(collection&#x3D;”user”) 注解标识为映射mongodb中的user表</p>
<p>@Id id为主键 自动对应_id</p>
<p>@Indexed 为其创建索引</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.pojo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.Indexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Document(collection=&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">	<span class="meta">@Indexed</span></span><br><span class="line">	<span class="keyword">private</span> String phoneNum;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Date regDate;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String nickName;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> String uname;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="type">double</span> money;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getMoney</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> money;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMoney</span><span class="params">(<span class="type">double</span> money)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.money = money;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getPhoneNum</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> phoneNum;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPhoneNum</span><span class="params">(String phoneNum)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.phoneNum = phoneNum;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> Date <span class="title function_">getRegDate</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> regDate;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRegDate</span><span class="params">(Date regDate)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.regDate = regDate;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getNickName</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> nickName;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNickName</span><span class="params">(String nickName)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.nickName = nickName;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">getUname</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> uname;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUname</span><span class="params">(String uname)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.uname = uname;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;User [id=&quot;</span> + id + <span class="string">&quot;, phoneNum=&quot;</span> + phoneNum + <span class="string">&quot;, regDate=&quot;</span> + regDate + <span class="string">&quot;, nickName=&quot;</span> + nickName</span><br><span class="line">				+ <span class="string">&quot;, uname=&quot;</span> + uname + <span class="string">&quot;, money=&quot;</span> + money + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入的数据通过@RequestBody 会自动通过set&#x2F;get注入到User类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;register&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">register</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">	<span class="comment">//System.out.println(user);</span></span><br><span class="line">	<span class="keyword">return</span> service.register(user);	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>service层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> dao.register(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dao层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">	User u=mongoTemplate.insert(user);</span><br><span class="line">	System.out.println(user);</span><br><span class="line">	<span class="keyword">if</span>(u!=<span class="literal">null</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看moogdb</p>
<p>use bike</p>
<p>db.user.find()</p>
<p>❌注册多个手机号</p>
<p>duplicate key error collection</p>
<h2 id="id-并不会自增">11.1. _id 并不会自增</h2><p>创建一个集合counters存入id，value</p>
<p>db.counters.insert({_id:”aid”,value:0})</p>
<p>每增加一条记录，令value自增+1，更新counters，取value值作为_id</p>
<p>counters中始终只有一条记录，故_id不会重复</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">register</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    <span class="comment">//从1开始自增，实现唯一</span></span><br><span class="line">		user.setId(getIncrement(<span class="string">&quot;aid&quot;</span>));</span><br><span class="line">		User u=mongoTemplate.insert(user);</span><br><span class="line">		System.out.println(user);</span><br><span class="line">		<span class="keyword">if</span>(u!=<span class="literal">null</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getIncrement</span><span class="params">(String id)</span>&#123;</span><br><span class="line">		<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line">		<span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">    <span class="comment">//value自增</span></span><br><span class="line">		update.inc(<span class="string">&quot;value&quot;</span>,<span class="number">1</span>);</span><br><span class="line">		mongoTemplate.updateFirst(query, update, Counters.class);</span><br><span class="line">    <span class="comment">//重新查找counters</span></span><br><span class="line">		Counters counters=mongoTemplate.findOne(query, Counters.class);</span><br><span class="line">    <span class="comment">//取value值</span></span><br><span class="line">		<span class="keyword">return</span> counters.getValue();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>实现</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/result.png"></p>
<h2 id="跳转页面-amp-存数据">11.2. 跳转页面&amp;存数据</h2><p>当&#x2F;user&#x2F;register返回true时，跳转到充值页面</p>
<p>注册充值页面</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;pages&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;pages/index/index&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;pages/register/register&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;pages/deposite/deposite&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;pages/logs/logs&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>

<p>register.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(res.<span class="property">data</span>)&#123;</span><br><span class="line">   wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: <span class="string">&#x27;../deposite/deposite&#x27;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>此时已完成注册手机号，应当保存用户状态，将状态设为全局变量</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新内存中的数据</span></span><br><span class="line"><span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">status</span> = <span class="number">1</span> </span><br><span class="line"><span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">phoneNum</span> = phoneNum</span><br></pre></td></tr></table></figure>

<p>并同时保存到手机内存中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">setStorageSync</span>(<span class="string">&quot;status&quot;</span>,<span class="number">1</span>)</span><br><span class="line">wx.<span class="title function_">setStorageSync</span>(<span class="string">&quot;phoneNum&quot;</span>,phoneNum)</span><br></pre></td></tr></table></figure>

<p>index页可以根据status状态在用户退出程序时保存用户状态，在扫码开锁的点击事件中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">1</span>:&#123;</span><br><span class="line">    <span class="comment">//扫码开锁按钮</span></span><br><span class="line">    <span class="comment">//数据来源于磁盘</span></span><br><span class="line">        <span class="keyword">var</span> status=<span class="title function_">getApp</span>().<span class="property">globalData</span>[<span class="string">&quot;status&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(status==<span class="number">0</span>)&#123;</span><br><span class="line">          wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;../register/register&#x27;</span>,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(status==<span class="number">1</span>)&#123;</span><br><span class="line">          wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;../deposite/deposite&#x27;</span>,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (status == <span class="number">2</span>) &#123;</span><br><span class="line">          wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;../identify/identify&#x27;</span>,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实数据可以来自内存，也可以是全局变量，新建myUtil.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查找的DATA</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">get</span>(<span class="params">key</span>) &#123;</span><br><span class="line">   <span class="comment">//内存</span></span><br><span class="line">    <span class="keyword">var</span> status = wx.<span class="title function_">getStorageSync</span>(key);</span><br><span class="line">    <span class="comment">//如果没有就在当前操作周期的全局找</span></span><br><span class="line">    <span class="keyword">if</span> (!status) &#123;</span><br><span class="line">       <span class="comment">//全局变量</span></span><br><span class="line">        status = <span class="title function_">getApp</span>().<span class="property">globalData</span>[key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.js导入包</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myUtils=<span class="built_in">require</span>(<span class="string">&quot;../../utils/myUtil.js&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> status=myUtils.<span class="title function_">get</span>(<span class="string">&quot;status&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="充值页面">12. 充值页面</h1><p>并不能实现个人账号支付，用loading模拟支付时长</p>
<p>点击按钮事件绑定 bindtap</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&#x27;primary&#x27;</span> <span class="attr">bindtap</span>=<span class="string">&#x27;deposit&#x27;</span>&gt;</span>去充值<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>事件</p>
<p>wx.showModal({})  提示框，res.confirm点确定事件，按取消，页面不动</p>
<p>wx.showLoading({}) mask启动一个面罩，整个页面不能点击</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deposit</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> that = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="comment">//获取用户的手机号</span></span><br><span class="line">    <span class="keyword">var</span> phoneNum = myUtils.<span class="title function_">get</span>(<span class="string">&quot;phoneNum&quot;</span>)</span><br><span class="line">    wx.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">      <span class="attr">title</span>:<span class="string">&quot;提示&quot;</span>,</span><br><span class="line">      <span class="attr">content</span>:<span class="string">&quot;是否进行充值&quot;</span>,</span><br><span class="line">      <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(res.<span class="property">confirm</span>)&#123;</span><br><span class="line">          wx.<span class="title function_">showLoading</span>(&#123;</span><br><span class="line">            <span class="attr">title</span>: <span class="string">&#x27;正在充值&#x27;</span>,</span><br><span class="line">            <span class="attr">mask</span>:<span class="literal">true</span> </span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/wallet.png"></p>
<p>请求充值，存入手机号和金额，成功后进入实名认证页面</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/user/deposite&#x27;</span>,</span><br><span class="line">   <span class="attr">method</span>:<span class="string">&quot;POST&quot;</span>,</span><br><span class="line"><span class="comment">//   header:&#123;</span></span><br><span class="line"><span class="comment">//       &#x27;content-type&#x27;: &quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line"><span class="comment">//  &#125;,</span></span><br><span class="line">   <span class="attr">data</span>:&#123;</span><br><span class="line">        <span class="attr">phoneNum</span>:phoneNum,</span><br><span class="line">        <span class="attr">deposit</span>:<span class="number">299</span>,</span><br><span class="line">   &#125;,</span><br><span class="line">  <span class="comment">//成功说明请求成功，及时关闭遮罩</span></span><br><span class="line">   <span class="attr">success</span>:<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">       <span class="comment">//console.log(res);</span></span><br><span class="line">        <span class="comment">// 关闭充值中的加载对话框</span></span><br><span class="line">        wx.<span class="title function_">hideLoading</span>()</span><br><span class="line">        <span class="keyword">if</span>(data.<span class="property">error</span>)&#123;</span><br><span class="line">            wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">                <span class="attr">url</span>: <span class="string">&#x27;../identify/identify&#x27;</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">          <span class="comment">//更新用户状态</span></span><br><span class="line">            <span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">status</span> = <span class="number">2</span> </span><br><span class="line">            wx.<span class="title function_">setStorageSync</span>(<span class="string">&quot;status&quot;</span>,<span class="number">2</span>)</span><br><span class="line">         &#125;</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="实名认证页面">13. 实名认证页面</h1><p>mongodb中存入用户名和身份证id，更新phoneNum相同的数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">formSubmit</span>: <span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">  <span class="comment">//获取全局变量</span></span><br><span class="line">  <span class="keyword">var</span> phoneNum = myUtils.<span class="title function_">get</span>(<span class="string">&quot;phoneNum&quot;</span>);</span><br><span class="line">  <span class="comment">//获取输入的姓名和身份证号</span></span><br><span class="line">  <span class="keyword">var</span> name = e.<span class="property">detail</span>.<span class="property">value</span>.<span class="property">name</span>;</span><br><span class="line">  <span class="keyword">var</span> idNum = e.<span class="property">detail</span>.<span class="property">value</span>.<span class="property">idNum</span>;</span><br><span class="line">  <span class="comment">//编辑遮罩</span></span><br><span class="line">  wx.<span class="title function_">showLoading</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&#x27;正在实名认证&#x27;</span>,</span><br><span class="line">    <span class="attr">mask</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;)  </span><br><span class="line">  wx.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/user/identify&#x27;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="comment">//传入参数</span></span><br><span class="line">      <span class="attr">phoneNum</span>: phoneNum,</span><br><span class="line">      <span class="attr">uname</span>: name,</span><br><span class="line">      <span class="attr">idNum</span>: idNum,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">res</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(res.<span class="property">data</span>)&#123;</span><br><span class="line">        wx.<span class="title function_">hideLoading</span>();</span><br><span class="line">        <span class="title function_">getApp</span>().<span class="property">globalData</span>.<span class="property">status</span> = <span class="number">3</span></span><br><span class="line">        wx.<span class="title function_">setStorageSync</span>(<span class="string">&#x27;status&#x27;</span>, <span class="number">3</span>)</span><br><span class="line">        wx.<span class="title function_">navigateTo</span>(&#123;</span><br><span class="line">          <span class="attr">url</span>: <span class="string">&#x27;../index/index&#x27;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">//响应404，400，500等</span></span><br><span class="line">    <span class="attr">fail</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      wx.<span class="title function_">hideLoading</span>()</span><br><span class="line">      wx.<span class="title function_">showModal</span>(&#123;</span><br><span class="line">        <span class="attr">title</span>: <span class="string">&#x27;提示&#x27;</span>,</span><br><span class="line">        <span class="attr">content</span>: <span class="string">&#x27;服务器繁忙，请销后再试&#x27;</span>,</span><br><span class="line">        <span class="attr">showCancel</span>: <span class="literal">false</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样使用RequestBody接收数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/identify&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">identify</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> service.identify(user);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mongodb更新语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">identify</span><span class="params">(User user)</span> &#123;</span><br><span class="line">		<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;phoneNum&quot;</span>).is(user.getPhoneNum()));</span><br><span class="line">  	<span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">		update.set(<span class="string">&quot;idNum&quot;</span>, user.getIdNum());</span><br><span class="line">		update.set(<span class="string">&quot;uname&quot;</span>, user.getUname());</span><br><span class="line">		UpdateResult result= mongoTemplate.updateFirst(query, update, User.class);</span><br><span class="line">		<span class="keyword">if</span>(result.getModifiedCount()!=<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h1 id="附近车辆">14. 附近车辆</h1><h2 id="添加车辆-临时数据">14.1. 添加车辆 - 临时数据</h2><p>添加车辆图标</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">that.<span class="title function_">setData</span>(&#123;	</span><br><span class="line">  <span class="attr">controls</span>:[</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="comment">//添加车辆</span></span><br><span class="line">        <span class="attr">id</span>: <span class="number">6</span>,</span><br><span class="line">        <span class="attr">iconPath</span>: <span class="string">&#x27;/images/add.png&#x27;</span>,</span><br><span class="line">        <span class="attr">position</span>: &#123;</span><br><span class="line">    				<span class="attr">width</span>: <span class="number">35</span>,</span><br><span class="line">            <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">            <span class="attr">left</span>: width / <span class="number">30</span>,</span><br><span class="line">            <span class="attr">top</span>: height / <span class="number">30</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">clickable</span>: <span class="literal">true</span></span><br><span class="line">     &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>添加点击事件</p>
<p>这里传入的是location:[log,lat] [经度，纬度]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">controltap:function(e)&#123;</span><br><span class="line">  <span class="type">var</span> <span class="variable">id</span> <span class="operator">=</span> e.controlId;</span><br><span class="line">    <span class="keyword">switch</span>(id)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        <span class="comment">//添加车辆</span></span><br><span class="line">        <span class="keyword">var</span> bikes=that.data.markers;</span><br><span class="line">        <span class="comment">//移动后获取中心点</span></span><br><span class="line">        <span class="built_in">this</span>.mapCtx.getCenterLocation(&#123;</span><br><span class="line">          success: function (res) &#123;</span><br><span class="line">            <span class="comment">//console.log(res);</span></span><br><span class="line">              <span class="keyword">var</span> log=res.longitude;</span><br><span class="line">              <span class="type">var</span> <span class="variable">lat</span> <span class="operator">=</span>res.latitude;</span><br><span class="line">       				<span class="keyword">var</span> bikeno=myUtils.get(<span class="string">&quot;bikeno&quot;</span>);</span><br><span class="line">            <span class="comment">//将数据发送到后台</span></span><br><span class="line">              wx.request(&#123;</span><br><span class="line">                url: <span class="string">&#x27;http://localhost:8080/bike/add&#x27;</span>,</span><br><span class="line">                data: &#123;</span><br><span class="line">                  bikeno:bikeno,</span><br><span class="line">                  location:[log,lat],</span><br><span class="line">                  status:<span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                method:<span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                success: function(res)&#123;</span><br><span class="line">                  bikeno=bikeno+<span class="number">1</span>;</span><br><span class="line">                  getApp().globalData.bikeno=bikeno;</span><br><span class="line">                  <span class="comment">//console.log(getApp().globalData.bikeno);</span></span><br><span class="line">                  <span class="comment">//保存到手机存储卡中</span></span><br><span class="line">                  wx.setStorageSync(<span class="string">&quot;bikeno&quot;</span>, bikeno)</span><br><span class="line">                  <span class="comment">//findBikes(log,lat,that);</span></span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)</span><br><span class="line">           &#125;</span><br><span class="line">         &#125;)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注册车辆到mongodb">14.2. 注册车辆到mongodb</h2><p>新建bikecounters用于bikes集合主键自增</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.bikecounters.insert(&#123;_id:&quot;aid&quot;,value:0&#125;)</span><br><span class="line">db.bikecounters.find()</span><br></pre></td></tr></table></figure>

<p>对应新建pojo-BikeCounters</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.Indexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Document(collection=&quot;bikecounters&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BikeCounters</span> &#123;</span><br><span class="line">	</span><br><span class="line">	   <span class="meta">@Id</span></span><br><span class="line">		<span class="keyword">private</span> String id;</span><br><span class="line">		<span class="meta">@Indexed</span></span><br><span class="line">		<span class="keyword">private</span> <span class="type">int</span> value;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> String <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> id;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(String id)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.id = id;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> value;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">			<span class="built_in">this</span>.value = value;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;BikeCounters [id=&quot;</span> + id + <span class="string">&quot;, value=&quot;</span> + value + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存储bikes，[id主键，bikeno车编号，location经纬度，status车辆状态]</p>
<p>@GeoSpatialIndexed 标记为其创建索引</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.runaccpeted.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.GeoSpatialIndexType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.GeoSpatialIndexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.index.Indexed;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.mongodb.core.mapping.Document;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Document(collection=&quot;bikes&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bike</span> &#123;</span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Indexed</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> bikeno;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GeoSpatialIndexed(type=GeoSpatialIndexType.GEO_2DSPHERE)</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">double</span>[] location;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="type">double</span>[] getLocation() &#123;</span><br><span class="line">		<span class="keyword">return</span> location;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocation</span><span class="params">(<span class="type">double</span>[] location)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.location = location;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getBikeno</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> bikeno;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBikeno</span><span class="params">(<span class="type">int</span> bikeno)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.bikeno = bikeno;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getStatus</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStatus</span><span class="params">(<span class="type">int</span> status)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.status = status;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;Bike [id=&quot;</span> + id + <span class="string">&quot;, bikeno=&quot;</span> + bikeno + <span class="string">&quot;, location=&quot;</span> + Arrays.toString(location) + <span class="string">&quot;, status=&quot;</span></span><br><span class="line">				+ status + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加车辆</p>
<p>注入车编号使用的是手机内存中存入全局变量bikeno:100000</p>
<p>每次调用bike&#x2F;add bikeno+1 ,所以会存在bikeno不会相同，而经纬度相同。</p>
<p>当经纬度相同时，用更新，不同时，用插入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(Bike bike)</span>&#123;</span><br><span class="line">		<span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;location&quot;</span>).is(bike.getLocation()));</span><br><span class="line">		<span class="keyword">if</span> (mongoTemplate.findOne(query, Bike.class)!=<span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>();</span><br><span class="line">			update.set(<span class="string">&quot;bikeno&quot;</span>, bike.getBikeno());</span><br><span class="line">			update.set(<span class="string">&quot;status&quot;</span>, bike.getStatus());</span><br><span class="line">			UpdateResult result= mongoTemplate.updateFirst(query, update, Bike.class);</span><br><span class="line">			<span class="keyword">if</span> (result.getModifiedCount()!=<span class="number">0</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			bike.setId(getIncrement(<span class="string">&quot;aid&quot;</span>));</span><br><span class="line">			<span class="type">Bike</span> <span class="variable">b</span> <span class="operator">=</span> mongoTemplate.insert(bike);</span><br><span class="line">			<span class="keyword">if</span> (b!=<span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">				</span><br><span class="line">			&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h2 id="显示附近车辆">14.3. 显示附近车辆</h2><p>findBikes(log,lat,that);</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">findBikes</span><span class="params">(longitude,latitude,that)</span>&#123;</span><br><span class="line">  wx.request(&#123;</span><br><span class="line">    url: <span class="string">&quot;http://localhost:8080/bike/findNear&quot;</span>,</span><br><span class="line">    method: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    data: &#123;</span><br><span class="line">      location: [longitude,latitude]</span><br><span class="line">    &#125;,</span><br><span class="line">    success: function (res) &#123;</span><br><span class="line">      console.log(res)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>从mongodb中读取附近车辆信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;GeoResult&lt;Bike&gt;&gt; <span class="title function_">findNear</span><span class="params">(Bike bike)</span> &#123;</span><br><span class="line">   <span class="comment">//中心位置</span></span><br><span class="line">		<span class="type">Point</span> <span class="variable">location</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Point</span>(bike.getLocation()[<span class="number">0</span>], bike.getLocation()[<span class="number">1</span>]);</span><br><span class="line">  <span class="comment">//获取车辆附近信息</span></span><br><span class="line">		<span class="type">NearQuery</span> <span class="variable">query</span> <span class="operator">=</span> NearQuery.near(location);</span><br><span class="line">  <span class="comment">//附近200m</span></span><br><span class="line">		query.maxDistance(<span class="number">0.2</span>,Metrics.KILOMETERS);</span><br><span class="line">  <span class="comment">//车辆状态为0 未使用 ，取20辆</span></span><br><span class="line">		query.query(<span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;status&quot;</span>).is(<span class="number">0</span>)).limit(<span class="number">20</span>));</span><br><span class="line">  </span><br><span class="line">		GeoResults&lt;Bike&gt; bikes=mongoTemplate.geoNear(query, Bike.class);</span><br><span class="line">		<span class="keyword">return</span> bikes.getContent();	</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>获取响应数据	</p>
<p>❌</p>
<p>“errmsg” : “no such command: ‘geoNear’”</p>
<p>？？ mongodb没安装好，重装还是一样问题？？版本问题，低版本下载？</p>
<p>安装mongodb-osx-ssl-x86_64-4.0.12.tgz 运行正确</p>
<p>返回数据</p>
<p><img src="/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/nearresult.png"></p>
<p>获取到经纬度，用map的markers属性，注入图标</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bikes = res.<span class="property">data</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">geoResult</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">         <span class="attr">longitude</span>: geoResult.<span class="property">content</span>.<span class="property">location</span>[<span class="number">0</span>],</span><br><span class="line">         <span class="attr">latitude</span>: geoResult.<span class="property">content</span>.<span class="property">location</span>[<span class="number">1</span>],</span><br><span class="line">         <span class="attr">width</span>: <span class="number">30</span>,</span><br><span class="line">         <span class="attr">height</span>: <span class="number">35</span>,</span><br><span class="line">         <span class="attr">iconPath</span>: <span class="string">&#x27;/images/bike.png&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">      &#125;</span><br><span class="line">     )</span><br><span class="line">     that.<span class="title function_">setData</span>(&#123;</span><br><span class="line">       <span class="attr">markers</span>: bikes</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>

<p>实现效果</p>
<video width="420" height="520" controls autoplay loop>
        <source src="/2019/08/09/微信小程序-共享单车/bike.mp4" type="video/mp4">    
 </video>
# <font size="4px">所用mongo命令</font>

<p>use bike</p>
<p>db.createUser({user:”bike”,pwd:”123456”,roles:[“readWrite”]})</p>
<p>db.auth(“bike”,”123456”)</p>
<p>db.usercounters.insert({_id:”aid”,value:0})</p>
<p>db.user.find()</p>
<p>db.usercounters.find()</p>
<p>db.usercounters.remove({})</p>
<p>db.user.drop()</p>
<p>db.bikecounters.insert({_id:”aid”,value:0})</p>
<p>db.bikes.find()</p>
<p>db.bikecounters.find()</p>
<p>db.bikecounters.remove({})</p>
<h1 id="扫码页面">15. 扫码页面</h1>
    </div>

    
    
    

    <div>      <div>
    
        <div style="margin-top:30px;padding-top:20px;border-top: 1px dashed #b3a9a7;text-align:center;color: #ccc;font-size:20px;">本文结束&nbsp;<i class="fa fa-paw"></i>&nbsp;感谢您的阅读</div>
    
</div>  </div>
        

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Wang Ting
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <!-- <a href="https://wtlumos.github.io/zh-CN/2019/08/09/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E5%85%B1%E4%BA%AB%E5%8D%95%E8%BD%A6/" title="微信小程序-共享单车">https://wtlumos.github.io/zh-CN/2019/08/09/微信小程序-共享单车/</a> -->
    
       <a href ="/zh-CN/2019/08/09/微信小程序-共享单车/" >/zh-CN/2019/08/09/微信小程序-共享单车/</a>
  </li>
       <li>
          <strong>发布时间：</strong>
          2019-08-09 07:56
      </li>
      <li>
          <strong>更新时间：</strong>
          2021-10-29 13:56

      </li>
  
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag"><i class="fa fa-tag"></i> 微信小程序</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/zh-CN/2019/08/09/CentOS6%E5%AE%89%E8%A3%85mysql/" rel="prev" title="CentOS6安装mysql">
      <i class="fa fa-chevron-left"></i> CentOS6安装mysql
    </a></div>
      <div class="post-nav-item">
    <a href="/zh-CN/2019/07/24/Java%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/" rel="next" title="Java学习路线">
      Java学习路线 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F"><span class="nav-text">1. 注册微信小程序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E8%80%85%E5%B7%A5%E5%85%B7%E4%B8%8B%E8%BD%BD"><span class="nav-text">2. 开发者工具下载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-text">3. 项目结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E5%9C%B0%E5%9B%BE"><span class="nav-text">4. 显示地图</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">5. 生命周期</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E5%AE%9A%E4%BD%8D"><span class="nav-text">6. 获取设备定位</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E4%BA%8B%E4%BB%B6"><span class="nav-text">7. 添加事件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E5%9B%BE%E7%89%87"><span class="nav-text">7.1. 添加图片</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E4%BA%8B%E4%BB%B6"><span class="nav-text">7.2. 绑定事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%82%B9%E5%87%BB%E4%BA%8B%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="nav-text">7.3. 点击事件实现</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot"><span class="nav-text">8. SpringBoot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%85%A8%E5%B1%80%E6%95%B0%E5%80%BC"><span class="nav-text">9. 设置全局数值</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2"><span class="nav-text">10. 注册页面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2"><span class="nav-text">10.1. 添加注册页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%89%8B%E6%9C%BA%E7%BB%91%E5%AE%9A"><span class="nav-text">10.2. 实现手机绑定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">10.2.1. 连接服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringBoot%E2%80%93redis"><span class="nav-text">10.2.2. SpringBoot–redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%85%BE%E8%AE%AF%E4%BA%91%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1"><span class="nav-text">10.2.3. 腾讯云短信服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E8%B0%83%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1"><span class="nav-text">10.2.4. 不调用腾讯云短信服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5"><span class="nav-text">10.2.5. 验证用户输入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E5%88%B0MongoDB"><span class="nav-text">11. 注册用户到MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#id-%E5%B9%B6%E4%B8%8D%E4%BC%9A%E8%87%AA%E5%A2%9E"><span class="nav-text">11.1. _id 并不会自增</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC%E9%A1%B5%E9%9D%A2-amp-%E5%AD%98%E6%95%B0%E6%8D%AE"><span class="nav-text">11.2. 跳转页面&amp;存数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%85%E5%80%BC%E9%A1%B5%E9%9D%A2"><span class="nav-text">12. 充值页面</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E5%90%8D%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2"><span class="nav-text">13. 实名认证页面</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%99%84%E8%BF%91%E8%BD%A6%E8%BE%86"><span class="nav-text">14. 附近车辆</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E8%BD%A6%E8%BE%86-%E4%B8%B4%E6%97%B6%E6%95%B0%E6%8D%AE"><span class="nav-text">14.1. 添加车辆 - 临时数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%BD%A6%E8%BE%86%E5%88%B0mongodb"><span class="nav-text">14.2. 注册车辆到mongodb</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%98%BE%E7%A4%BA%E9%99%84%E8%BF%91%E8%BD%A6%E8%BE%86"><span class="nav-text">14.3. 显示附近车辆</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%AB%E7%A0%81%E9%A1%B5%E9%9D%A2"><span class="nav-text">15. 扫码页面</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wang Ting"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Wang Ting</p>
  <div class="site-description" itemprop="description">技术成长笔记</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">381</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">25</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">46</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/WTlumos" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;WTlumos" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/7807823198" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;7807823198" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-glasses fa-fw"></i>
      最近阅读
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://www.bilibili.com/video/av77638697/" title="https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;av77638697&#x2F;" rel="noopener" target="_blank">浙江大学-研究生机器学习课程</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wang Ting</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span>网站总字数: </span>
    <span title="站点总字数">2.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
        <span>阅读总时长: </span>
    <span title="站点阅读时长">44:22</span>
</div>

<span id="sitetime"></span>

<script language=javascript>
  function siteTime(){
    window.setTimeout("siteTime()", 1000);
    var seconds = 1000;
    var minutes = seconds * 60;
    var hours = minutes * 60;
    var days = hours * 24;
    var years = days * 365;
    var today = new Date();
    var todayYear = today.getFullYear();
    var todayMonth = today.getMonth()+1;
    var todayDate = today.getDate();
    var todayHour = today.getHours();
    var todayMinute = today.getMinutes();
    var todaySecond = today.getSeconds();
    /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
    year - 作为date对象的年份，为4位年份值
    month - 0-11之间的整数，做为date对象的月份
    day - 1-31之间的整数，做为date对象的天数
    hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
    minutes - 0-59之间的整数，做为date对象的分钟数
    seconds - 0-59之间的整数，做为date对象的秒数
    microseconds - 0-999之间的整数，做为date对象的毫秒数 */
    var t1 = Date.UTC(2018,07,01,00,00,00); //北京时间2018-07-01 00:00:00
    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
    var diff = t2-t1;
    var diffYears = Math.floor(diff/years);
    var diffDays = Math.floor((diff/days)-diffYears*365);
    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);

    if(window.location.pathname=='/en/'){
           document.getElementById("sitetime").innerHTML=" Run for "+ diffYears+" Year "+ diffDays+" Days "+diffHours+" Hours "+diffMinutes+" Minute "+diffSeconds+" Second";
    }else{
          document.getElementById("sitetime").innerHTML=" 已运行 "+ diffYears+" 年 "+ diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
    }

  }
  siteTime();
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>




  




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : 'fb5f16fdf7649a9e5208',
      clientSecret: 'bcd95c87cdbab8fa32fc1b006fbb1ce7e8ffae5b',
      repo        : 'wtlumos.github.io',
      owner       : 'WTlumos',
      admin       : ['WTlumos'],
      id          : '148e0e9c81965571ee7a9c990c290425',
        language: '',
      distractionFreeMode: false
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":125,"height":290,"hOffset":-15,"vOffset":-40},"mobile":{"show":true,"scale":0.5},"react":{"opacity":0.7},"dialog":{"enable":false,"hitokoto":false},"log":false});</script></body>
</html>
